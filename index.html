<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototype-1</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <h1>Automatic Invoice Maker</h1>
    <form onsubmit="generateInvoice(event)">
        <fieldset>
            <legend>Invoice Details</legend>
            <div class="form-group">
                <label for="invoice-number">Invoice Number:</label>
                <input type="text" id="invoice-number" name="invoice-number" required>
            </div>
        </fieldset>
        <fieldset>
            <legend>Customer Details</legend>
            <div class="form-group">
                <label for="customer-name">Name:</label>
                <input type="text" id="customer-name" name="customer-name" required>
            </div>
            <div class="form-group">
                <label for="customer-email">Email:</label>
                <input type="email" id="customer-email" name="customer-email" required>
            </div>
            <div class="form-group">
                <label for="customer-phone">Phone:</label>
                <input type="tel" id="customer-phone" name="customer-phone">
            </div>
            <div class="form-group">
                <label for="billing-address">Billing Address:</label>
                <input type="text" id="billing-address" name="billing-address" required>
            </div>
            <div class="form-group">
                <input type="checkbox" id="same-address" name="same-address" checked>
                <label for="same-address">Shipping Address same as Billing Address</label>
            </div>
            <div class="form-group" id="shipping-details-group" style="display: none;">
                <label for="shipping-name">Shipping Name:</label>
                <input type="text" id="shipping-name" name="shipping-name">
                <label for="shipping-email">Shipping Email:</label>
                <input type="email" id="shipping-email" name="shipping-email">
                <label for="shipping-phone">Shipping Phone:</label>
                <input type="tel" id="shipping-phone" name="shipping-phone">
                <label for="shipping-address">Shipping Address:</label>
                <input type="text" id="shipping-address" name="shipping-address">
            </div>
        </fieldset>
        <fieldset>
            <legend>Invoice Items</legend>
            <div id="product-container">
                <div class="product-item">
                    <div class="form-group">
                        <label for="item-name">Item Name:</label>
                        <select name="item-name[]" class="product-dropdown" required>
                            <option value="" disabled selected>Select a product</option>
                            <option value="Instant Coffee (SD)">Instant Coffee (SD)</option>
                            <option value="Instant Coffee (Agglo)">Instant Coffee (Agglo)</option>
                            <option value="Instant Coffee (FD)">Instant Coffee (FD)</option>
                            <option value="Coffee Premix">Coffee Premix</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item-quantity">Quantity:</label>
                        <input type="number" name="item-quantity[]" required>
                    </div>
                    <div class="form-group">
                        <label for="item-price">Price:</label>
                        <input type="number" name="item-price[]" step="0.01" required>
                    </div>
                </div>
            </div>
            <button type="button" onclick="addProductFields()">Add Another Product</button>
        </fieldset>
        <fieldset>
            <legend>Additional Charges</legend>
            <div class="form-group">
                <label for="freight-charges">Freight Charges:</label>
                <input type="number" id="freight-charges" name="freight-charges" step="0.01">
            </div>
        </fieldset>
        <button type="submit">Generate Invoice</button>
    </form>
    <div id="invoice-container"></div>
    <button id="download-button" onclick="downloadPDF()">Download PDF</button>
    <script>
        function addProductFields() {
            const container = document.getElementById('product-container');
            const productFields = `
                <div class="product-item">
                    <div class="form-group">
                        <label for="item-name">Item Name:</label>
                        <select name="item-name[]" class="product-dropdown" required>
                            <option value="" disabled selected>Select a product</option>
                            ${window.productDetails.map(product => `<option value="${product.name}">${product.name} (${product.unit})</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item-quantity">Quantity:</label>
                        <input type="number" name="item-quantity[]" required>
                    </div>
                    <div class="form-group">
                        <label for="item-price">Price:</label>
                        <input type="number" name="item-price[]" step="0.01" required>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', productFields);
            $('.product-dropdown').select2();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('products.json'); // Fetch the JSON file
                const products = await response.json(); // Parse the JSON data
                window.productDetails = products;
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        });

        async function generateInvoice(event) {
            event.preventDefault();

            const invoiceNumber = document.getElementById('invoice-number').value;
            const invoiceDate = new Date().toLocaleDateString();

            const customerName = document.getElementById('customer-name').value;
            const customerEmail = document.getElementById('customer-email').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const billingAddress = document.getElementById('billing-address').value;

            let shippingName = customerName;
            let shippingEmail = customerEmail;
            let shippingPhone = customerPhone;
            let shippingAddress = billingAddress;

            if (!document.getElementById('same-address').checked) {
                shippingName = document.getElementById('shipping-name').value;
                shippingEmail = document.getElementById('shipping-email').value;
                shippingPhone = document.getElementById('shipping-phone').value;
                shippingAddress = document.getElementById('shipping-address').value;
            }

            const freightCharges = parseFloat(document.getElementById('freight-charges').value) || 0;

            const productContainer = document.getElementById('product-container');
            const productItems = productContainer.querySelectorAll('.product-item');

            let totalQty = 0, totalTaxableValue = 0, totalGstAmount = 0, totalAmount = 0;

            let invoiceHTML = `
                <h2>Purple Bean Agro Industries Pvt. Ltd.</h2>
                <p>PBAI Pvt Ltd, nr. Dapodi Metro Station, Dapodi, Pune, Pimpri-Chinchwad, Maharashtra 411012</p>
                <p>Phone: 8101287339 | Email: purplebeanagro@gmail.com</p>
                <p>GST: 27AIPPD4664G1Z2 | PAN: AAPCP3820M</p>
                <h2>TAX INVOICE</h2>
                <p><strong>Invoice Number:</strong> ${invoiceNumber}</p>
                <p><strong>Invoice Date:</strong> ${invoiceDate}</p>
                <div class="details">
                    <div>
                        <h3>Details of Receiver (Billing Address)</h3>
                        <p><strong>Name:</strong> ${customerName}</p>
                        <p><strong>Email:</strong> ${customerEmail}</p>
                        <p><strong>Phone:</strong> ${customerPhone}</p>
                        <p><strong>Address:</strong> ${billingAddress}</p>
                    </div>
                    <div>
                        <h3>Details of Consignee (Shipping Address)</h3>
                        <p><strong>Name:</strong> ${shippingName}</p>
                        <p><strong>Email:</strong> ${shippingEmail}</p>
                        <p><strong>Phone:</strong> ${shippingPhone}</p>
                        <p><strong>Address:</strong> ${shippingAddress}</p>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Sr. No</th>
                            <th>Name of Product</th>
                            <th>HSN/SAC</th>
                            <th>QTY</th>
                            <th>Unit</th>
                            <th>Rate</th>
                            <th>Taxable Value</th>
                            <th>GST Rate</th>
                            <th>GST Amount</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            productItems.forEach((item, index) => {
                const itemName = item.querySelector('[name="item-name[]"]').value;
                const itemQuantity = parseFloat(item.querySelector('[name="item-quantity[]"]').value);

                const product = window.productDetails.find(p => p.name === itemName);
                const hsn = product.hsn;
                const gstRate = product.gstRate;
                const unit = product.unit;
                const itemPrice = product.price;

                const taxableValue = (itemQuantity * itemPrice).toFixed(2);
                const gstAmount = ((taxableValue * gstRate) / 100).toFixed(2);
                const total = (parseFloat(taxableValue) + parseFloat(gstAmount)).toFixed(2);

                totalQty += itemQuantity;
                totalTaxableValue += parseFloat(taxableValue);
                totalGstAmount += parseFloat(gstAmount);
                totalAmount += parseFloat(total);

                invoiceHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${itemName}</td>
                        <td>${hsn}</td>
                        <td>${itemQuantity}</td>
                        <td>${unit}</td>
                        <td>${itemPrice}</td>
                        <td>${taxableValue}</td>
                        <td>${gstRate}%</td>
                        <td>${gstAmount}</td>
                        <td>${total}</td>
                    </tr>
                `;
            });

            const freightGstAmount = ((freightCharges * 18) / 100).toFixed(2);
            const freightTotal = (freightCharges + parseFloat(freightGstAmount)).toFixed(2);

            totalTaxableValue += freightCharges;
            totalGstAmount += parseFloat(freightGstAmount);
            totalAmount += parseFloat(freightTotal);

            invoiceHTML += `
                    <tr>
                        <td colspan="6"><strong>Freight Charges</strong></td>
                        <td>${freightCharges.toFixed(2)}</td>
                        <td>18%</td>
                        <td>${freightGstAmount}</td>
                        <td>${freightTotal}</td>
                    </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>Total</strong></td>
                            <td><strong>${totalQty}</strong></td>
                            <td></td>
                            <td></td>
                            <td><strong>${totalTaxableValue.toFixed(2)}</strong></td>
                            <td></td>
                            <td><strong>${totalGstAmount.toFixed(2)}</strong></td>
                            <td><strong>${totalAmount.toFixed(2)}</strong></td>
                        </tr>
                    </tfoot>
                </table>
                <p><strong>Bank Details:</strong></p>
                <p>Acc Holder Name: Purple Bean Agro Industries Pvt. Ltd.</p>
                <p>Bank Account Number: 10227953860</p>
                <p>Bank IFSC Code: IDFB0041438</p>
                <p>Bank Name: IDFC FIRST Bank</p>
                <p>Bank Branch Name: CHAKAN BRANCH</p>
            `;

            const invoiceContainer = document.getElementById('invoice-container');
            invoiceContainer.innerHTML = invoiceHTML;

            const downloadButton = document.getElementById('download-button');
            downloadButton.style.display = 'block';
        }

        function downloadPDF() {
            const invoiceContainer = document.getElementById('invoice-container');
            const { jsPDF } = window.jspdf;

            html2canvas(invoiceContainer, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4' // Set page size to A4
                });

                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const imgWidth = pageWidth - 20; // Leave margins
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);

                // Handle multi-page content
                if (imgHeight > pageHeight - 20) {
                    const remainingHeight = imgHeight - (pageHeight - 20);
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, -remainingHeight, imgWidth, imgHeight);
                }

                // Create a Blob for the PDF file
                const pdfBlob = doc.output('blob');
                const blobURL = URL.createObjectURL(pdfBlob);

                // Create a temporary link for downloading
                const link = document.createElement('a');
                link.href = blobURL;
                link.download = 'invoice.pdf';
                link.style.display = 'none';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        document.getElementById('same-address').addEventListener('change', function () {
            const shippingDetailsGroup = document.getElementById('shipping-details-group');
            shippingDetailsGroup.style.display = this.checked ? 'none' : 'block';
        });
    </script>
</body>
</html>