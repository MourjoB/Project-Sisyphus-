<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>Invoice Generator - Reference Format</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <h1>Automatic Invoice Maker</h1>
    <form onsubmit="generateInvoice(event)">
        <fieldset>
            <legend>Invoice Details</legend>
            <div class="form-group">
                <label for="invoice-number">Invoice Number:</label>
                <input type="text" id="invoice-number" required>
            </div>
            <div class="form-group">
                <label for="invoice-date">Invoice Date:</label>
                <input type="date" id="invoice-date" required>
            </div>
        </fieldset>
        <fieldset>
            <legend>Customer Details</legend>
            <div class="form-group">
                <label for="customer-name">Customer Name:</label>
                <input type="text" id="customer-name" required>
            </div>
            <div class="form-group">
                <label for="customer-email">Email:</label>
                <input type="email" id="customer-email">
            </div>
            <div class="form-group">
                <label for="customer-phone">Phone:</label>
                <input type="tel" id="customer-phone">
            </div>
            <div class="form-group">
                <label for="billing-address">Billing Address:</label>
                <input type="text" id="billing-address" required>
            </div>
            <div class="form-group">
                <input type="checkbox" id="same-address" checked>
                <label for="same-address">Shipping address same as billing</label>
            </div>
            <div id="shipping-fields" style="display: none;">
                <div class="form-group">
                    <label for="shipping-name">Shipping Name:</label>
                    <input type="text" id="shipping-name">
                </div>
                <div class="form-group">
                    <label for="shipping-email">Shipping Email:</label>
                    <input type="email" id="shipping-email">
                </div>
                <div class="form-group">
                    <label for="shipping-phone">Shipping Phone:</label>
                    <input type="tel" id="shipping-phone">
                </div>
                <div class="form-group">
                    <label for="shipping-address">Shipping Address:</label>
                    <input type="text" id="shipping-address">
                </div>
            </div>
        </fieldset>
        <fieldset>
            <legend>Invoice Items</legend>
            <div id="product-container">
                <div class="product-item">
                    <div class="form-group">
                        <label>Item Name:</label>
                        <select name="item-name[]" class="product-dropdown" required></select>
                    </div>
                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" name="item-quantity[]" required>
                    </div>
                    <div class="form-group">
                        <label>Price:</label>
                        <input type="number" name="item-price[]" step="0.01" required>
                    </div>
                </div>
            </div>
            <button type="button" onclick="addProductFields()">Add Another Product</button>
        </fieldset>
        <fieldset>
            <legend>Additional Charges</legend>
            <div class="form-group">
                <label for="freight-charges">Freight Charges:</label>
                <input type="number" id="freight-charges" step="0.01">
            </div>
        </fieldset>
        <button type="submit">Generate Invoice</button>
    </form>
    <button id="download-button" onclick="downloadPDF()">Download PDF</button>

    <script>
        document.getElementById('same-address').addEventListener('change', function () {
            document.getElementById('shipping-fields').style.display = this.checked ? 'none' : 'block';
        });

        function addProductFields() {
            const container = document.getElementById('product-container');
            const productFields = `
                <div class="product-item">
                    <div class="form-group">
                        <label>Item Name:</label>
                        <select name="item-name[]" class="product-dropdown" required></select>
                    </div>
                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" name="item-quantity[]" required>
                    </div>
                    <div class="form-group">
                        <label>Price:</label>
                        <input type="number" name="item-price[]" step="0.01" required>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', productFields);
            populateDropdowns();
        }

        function populateDropdowns() {
            const selects = document.querySelectorAll('.product-dropdown');
            selects.forEach(select => {
                if (select.options.length <= 1) {
                    select.innerHTML = '<option value="" disabled selected>Select a product</option>' +
                        window.productDetails.map(p => `<option value="${p.name}">${p.name} (${p.unit})</option>`).join('');
                }
            });
            $('.product-dropdown').select2();
        }

        async function generateInvoice(event) {
            event.preventDefault();
            document.getElementById('download-button').style.display = 'block';
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const invoiceNo = document.getElementById('invoice-number').value;
            const invoiceDate = document.getElementById('invoice-date').value || new Date().toLocaleDateString();
            const customerName = document.getElementById('customer-name').value;
            const customerEmail = document.getElementById('customer-email').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const billingAddress = document.getElementById('billing-address').value;

            let shippingName = customerName;
            let shippingEmail = customerEmail;
            let shippingPhone = customerPhone;
            let shippingAddress = billingAddress;

            if (!document.getElementById('same-address').checked) {
                shippingName = document.getElementById('shipping-name').value;
                shippingEmail = document.getElementById('shipping-email').value;
                shippingPhone = document.getElementById('shipping-phone').value;
                shippingAddress = document.getElementById('shipping-address').value;
            }

            // Header
            doc.setFontSize(14);
            doc.text("SHREE UTSAV FOODS AND BEVERAGES", 10, 10);
            doc.setFontSize(10);
            doc.text("34/2/3/4, Vijay Nagar, Navecha Road, Pimple Gurav, Pune, Maharashtra - 411061", 10, 16);
            doc.text("9309359125 | shreeutsavfnb@gmail.com", 10, 22);
            doc.text("GSTIN : 27AIPPD4664G1Z2 | PAN : AIPPD4664G", 10, 28);

            doc.setFontSize(12);
            doc.text("TAX INVOICE", 85, 36);
            doc.setFontSize(10);
            doc.text("Original for Recipient", 10, 42);
            doc.text("Invoice No.: " + invoiceNo, 10, 48);
            doc.text("Invoice Date: " + invoiceDate, 150, 48);

            doc.text("Details of Receiver:", 10, 56);
            doc.text(customerName, 10, 61);
            doc.text(billingAddress, 10, 66);
            doc.text(customerPhone, 10, 71);
            doc.text("GSTIN: ____________", 10, 76);

            doc.text("Details of Consignee:", 110, 56);
            doc.text(shippingName, 110, 61);
            doc.text(shippingAddress, 110, 66);
            doc.text(shippingPhone, 110, 71);
            doc.text("GSTIN: ____________", 110, 76);

            const productItems = document.querySelectorAll('.product-item');
            const rows = [];
            let totalQty = 0;
            let totalTaxable = 0;
            let totalGst = 0;
            let total = 0;

            productItems.forEach((item, index) => {
                const name = item.querySelector('[name="item-name[]"]').value;
                const qty = parseFloat(item.querySelector('[name="item-quantity[]"]').value);
                const price = parseFloat(item.querySelector('[name="item-price[]"]').value);
                const product = window.productDetails.find(p => p.name === name);

                const unit = product.unit;
                const hsn = product.hsn;
                const gst = product.gstRate;
                const taxable = (qty * price);
                const gstAmt = taxable * gst / 100;
                const totalRow = taxable + gstAmt;

                rows.push([index + 1, name, hsn, qty, unit, price.toFixed(2), taxable.toFixed(2), `${gst}%`, gstAmt.toFixed(2), totalRow.toFixed(2)]);

                totalQty += qty;
                totalTaxable += taxable;
                totalGst += gstAmt;
                total += totalRow;
            });

            const freight = parseFloat(document.getElementById('freight-charges').value) || 0;
            if (freight > 0) {
                const gstAmt = freight * 0.18;
                const totalRow = freight + gstAmt;
                rows.push(['', 'Freight Charges', '', '', '', '', freight.toFixed(2), '18%', gstAmt.toFixed(2), totalRow.toFixed(2)]);
                totalTaxable += freight;
                totalGst += gstAmt;
                total += totalRow;
            }

            doc.autoTable({
                startY: 82,
                head: [[
                    'Sr. No', 'Name of Product', 'HSN/SAC', 'QTY', 'Unit', 'Rate',
                    'Taxable Value', 'IGST Rate', 'IGST Amount', 'Total'
                ]],
                body: rows,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [0, 123, 255] }
            });

            const finalY = doc.lastAutoTable.finalY;
            doc.text(`Total Quantity: ${totalQty}`, 10, finalY + 10);
            doc.text(`Total Amount Before Tax: ₹${totalTaxable.toFixed(2)}`, 10, finalY + 16);
            doc.text(`IGST: ₹${totalGst.toFixed(2)}`, 10, finalY + 22);
            doc.text(`Amount With Tax: ₹${total.toFixed(2)}`, 10, finalY + 28);

            doc.text("Certified that the particulars given above are true and correct", 10, finalY + 36);
            doc.text("For, SHREE UTSAV FOODS AND BEVERAGES", 10, finalY + 42);
            doc.text("Authorised Signatory", 10, finalY + 48);

            doc.save("invoice.pdf");
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const response = await fetch('products.json');
            const products = await response.json();
            window.productDetails = products;
            populateDropdowns();
        });
    </script>
</body>
</html>
